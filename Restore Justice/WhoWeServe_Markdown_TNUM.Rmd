---
title: "Who We Serve"
author: "Alison Turner"
date: "4/1/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r setup2}
#devtools::install_github("arazdow/tnum/tnum")

library(tnum)
library(jsonlite)
library(tidyverse)
library(tigris)
library(stringr)
library(data.table)
library(lubridate)
library(censusapi)
library(sf)

# login to tnum server
creds <- "alison@metricstogether.com:brushfire"
ip <- "metrics.truenum.com:8080"
tnum.authorize(ip=ip,creds=creds)

#pull corrections data from TNUM server

subj <- tnum.getAllSubjects()
subj <- tibble(subj=unlist(subj))
counties <- tibble(unlist(str_split(subj$subj,"county:")))
c_len <- sapply(counties,str_length)
counties <- distinct(counties[c_len<20,])
names(counties)="counties"

data_tnum_og <- data.frame()


start <- Sys.time()
for (i in c(4:6,12) ){ 
  data_tnum_og <- rbind2(data_tnum_og, tnum.query(query=paste0("subj:*",counties[i,]),max=300001))
}

end <- Sys.time()

runtime <- end-start
runtime



data_tnum_og <- data_tnum_og %>% mutate(early=str_match(data_tnum_og$subject, "/\\s*(.*?)\\:inmate")) %>% mutate(identifier=substr(early,str_length(early)-5,str_length(early))[,2])

data_tnum <- data_tnum_og #data_tnum_og[-1,]

data <- data_tnum %>% select(identifier,property,value)

#structure into a workable dataframe

# function to rewrite wrong birthdates (lubridate)
date_redo <- function(x, year=2022){
  m <- year(x)
  n <- year(x) %% 100
  year(x) <- ifelse(m-year > 0, 1900+n, m)
  x
}

#clean up data that are notes 
#data <- data %>% filter(property, -"text:heading:full")

#note for complete cases df %>% filter(complete.cases(.))


d <- data %>% pivot_wider(names_from = property, values_from=value, values_fill=NA) %>%  unnest(cols = c(unique(data_tnum$property))) 


d$`Date-of-Birth` <- dmy(d$`Date-of-Birth`)
d$`Sentence-Date` <- dmy(d$`Sentence-Date`)

d$`Date-of-Birth` <- date_redo(d$`Date-of-Birth`)
#d$`Sentence-Years` <- is.numeric(d$`Sentence-Years`)
d$yeartrans <- ifelse(grepl("^[[:digit:]]+$",d$`Sentence-Years`),d$`Sentence-Years`,NA)
d$yeartrans <- as.numeric(d$yeartrans)
d <- d %>% 
  mutate(age=year(Sys.Date())-year(`Date-of-Birth`),
         life=ifelse(`Sentence-Years`=="LIFE",1,(ifelse(yeartrans>49,"De Facto",0))),
         sdp=ifelse(`Sentence-Years`=="SDP",1,0),
         "Sentence Age" = year(d$`Sentence-Date`)-year(d$`Date-of-Birth`)) %>% select(-yeartrans)

names


library(ggplot2)

ggplot(d) +
 aes(x = life, fill = Race) +
 geom_bar() +
 scale_fill_hue(direction = 1) +
 theme_minimal()
#tnum.getAllProperties()


```


```{r ACS pull}
#replace with a local census key 
key <- "095f223bd2d9dd69b8546222bde6c171c540da9b"

race_vars <- c("B01001A_001E","B01001B_001E","B01001C_001E","B01001D_001E","B01001E_001E","B01001F_001E","B01001G_001E","B01001H_001E","B01001I_001E")

acs5_race_17 <- getCensus(name = "acs/acs5",
                       vintage = 2017,
                       vars = race_vars,
                       key = key,
                       region="county:*",
                       regionin = "state:17")
acs5_race_17$year <- 2017

acs5_race_20 <- getCensus(name = "acs/acs5",
                          vintage = 2020,
                          vars = race_vars,
                          key = key,
                          region="county:*",
                          regionin = "state:17")
acs5_race_20$year <- 2020

acs5_race <- rbind(acs5_race_17,acs5_race_20)

acs5_race <- fips_to_acs(acs5_race)
acs5_race <- acs5_race %>% select (year,state_name,county.y,"B01001A_001E","B01001B_001E","B01001C_001E","B01001D_001E","B01001E_001E","B01001F_001E","B01001G_001E","B01001H_001E","B01001I_001E" )

names(acs5_race) <- c("year","state","county", 
                      "white alone",
                      "black alone",
                      "american indian or alaska native alone",
                      "asian alone",
                      "native hawaiian or pacific islander alone",
                      "some other race alone",
                      "two or more races",
                      "white alone, not hispanic or latino",
                      "hispanic or latino, any race category"
)


#transformation of data frame to align with IDOC data 
acs5_race$county <- str_remove(acs5_race$county," County")
acs5_race$total <- rowSums(acs5_race[,4:10])
acs5_race_perc <- data.frame(acs5_race[,1:3],lapply(acs5_race[,4:10],function(x) (x/acs5_race$total)*100))
acs5_race_perc$check <- rowSums(acs5_race_perc[,4:10])
15
IL_counties <- tigris::counties(state=17) %>%
  select(county = NAME,geometry) %>% 
  st_transform(4326) 

names(acs5_race_perc)[4:10] <- c("White","Black","American Indian","Asian","Native Hawaiian","Unknown","Bi-Racial")


ACS_IL <- acs5_race_perc %>% 
  select(-check) %>% 
  pivot_longer(cols = 4:10,names_to = "Race")


ACS_IL <- left_join(ACS_IL,IL_counties)

```


## Who We Serve


In Illinois today, there are 2,625 people taken into custody before the age of 26 serving sentences of life and de facto life in state prisons. De facto life is defined by the United States Sentencing Commission as termed sentences longer than 40 years. These people represent about 1 percent (29,111) of Illinois’s prison population.

Each case and person is unique, and few statements can describe all individuals serving extreme sentences. That said, knowing at a broad level who bears the burden of the state’s most extreme sentences helps us understand the issues, craft more nuanced policies, and build common ground for dialogue between communities, advocates, and legislators.

Here’s what we know about this group of individuals.


```{r Who We Serve}

d26 <- d %>% filter(`Sentence Age`<27)

county_life <- d26[d26$life %in% c("De Facto", 1),]%>% group_by(`Sentencing County`,Race) %>% summarise(number=n()) %>% mutate(percent=(number/sum(number))*100)
county_life2 <- left_join(county_life,ACS_IL[ACS_IL$year==2017,],by=c("Sentencing County"="county","Race"="Race"))
county_life2 <- county_life2 %>% mutate(diff=percent-value)

county_life_sums <- county_life2 %>%
  group_by(`Sentencing County`) %>%
  summarise(sum=sum(number)) 
county_life_sums <- distinct(left_join(county_life_sums,county_life2[c(1,8)]))

ggplot()+
  geom_sf(data=IL_counties)+
  geom_sf(data=county_life2[county_life2$Race=="Black",], mapping=aes(fill=diff,geometry=geometry))+
  geom_sf_text(data=county_life_sums,mapping = aes(label=sum,geometry=geometry),color="white")

```


## Who They Are

Overwhelmingly, the people in Illinois serving life and de facto life for offenses that occurred before the age of 26 are young Black men from Cook and its neighboring counties. Figure 1 shows the distribution of sentences by race, compared with Illinois demographics.

Eighty-three of Illinois’s 102 counties have sentenced at least one person to life or de facto life (among the people still serving these sentences) for an offense that occurred before the person’s 26th birthday. Sixty-five percent (1,706) of the people currently serving life or de facto life for crimes that occurred before they turned 26 are from Cook County. 

```{r Who they Are}

life_county_sentence <- length(unique(IDOC26$`Sentencing County`[IDOC26$life %in% c("De Facto", 1)]))
length(IDOC26[IDOC26$life %in% c("De Facto", 1) & IDOC26$`Sentencing County`=="Cook",])/life_county_sentence


# About 96 percent of youth life and de facto life sentences are for homicide-related offenses. 
youthhom <- length(IDOC$life[IDOC$life %in% c("De Facto", 1) & str_detect(IDOC$`Holding Offense`,"MURDER")])/length(IDOC$life[IDOC$life %in% c("De Facto", 1)])
youthhom

# Sixty-eight percent (1,790) of the people serving life or de facto life for crimes that occurred in their youth are Black.
ggplot(IDOC) +
  aes(x = life, fill = Race) +
  geom_bar() +
  scale_fill_hue(direction = 1) +
  theme_minimal()


blacklife <- length(IDOC$life[IDOC$life %in% c("De Facto", 1) & IDOC$Race=="Black"])/length(IDOC$life[IDOC$life %in% c("De Facto", 1)])
blacklife
```

## When They Enter


Almost half (49%) of all people sentenced to life and de facto in Illinois entered custody before the age of 26.

About 1 in 5 (28%) entered custody before the age of 21, some as young as 13 years old, much too young to drive a car or vote.

More than half (53%) of the people currently serving youth life or de facto life received their sentences before 2004.

Figure 2 shows the distribution of ages when individuals were taken into custody.

Figure 3 shows the distribution of sentence year for the current population of serving individuals.

